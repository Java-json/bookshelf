"use strict";define(["jquery","app"],function(a,b){b.controller("cprMonitorController",["$scope","webSocketService","applicationService","$interval","$window","messageBoxService","$location","$timeout",function(n,o,q,p,k,t,e,y){if(o.webSocket==null){e.url("");return false}if(!q.getQcprStatus()){e.url("score");return false}if(a(".container").parent().height()<q.getMbHeight()){a(".container").parent().css("height","100%")}n.time=0;n.examTime="00:00:00";n.wifiStatus="images/icon_link.png";n.pauseStatus=true;var j=x();function x(){return p(function(){var B=n.time%60;if(B<10){B="0"+B}var C=parseInt(n.time/60);if(C<10){C="0"+C}var A=parseInt(n.time/3600);if(A<10){A="0"+A}n.examTime=A+":"+C+":"+B;n.time=n.time+1},1000)}q.checkBrowers();clearStudentData(n.robotName);createData(n.robotName);var u=getAirWayStatus(n.robotName);if(u==1){a("#div_airway").css("background-color","green")}else{a("#div_airway").css("background-color","red")}var g=getToothStatus(n.robotName);if(g==1){a("#div_tooth").css("background-color","green")}else{a("#div_tooth").css("background-color","red")}k.onunload=function(A){q.exit();return false};n.$on("onOpen",function(A,B){n.wifiStatus="images/icon_link.png";a(".bootbox-close-button").trigger("click");j=x()});n.$on("onError",function(B,C){var A=new delayTask(function(){p.cancel(j)});A.delay(500);n.wifiStatus="images/icon_nolink.png";t.wrong("连接出错,等待重连,请不要关闭窗口.")});n.$on("onClose",function(B,C){if(q.getQcprStatus()){var A=new delayTask(function(){p.cancel(j)});A.delay(500);n.wifiStatus="images/icon_nolink.png";t.wrong("连接关闭,等待重连,请不要关闭窗口.")}});n.$on("onMessage",function(aj,ai){if(n.pauseStatus==false){return false}var ai=JSON.parse(ai);var D=ai.code;var H=ai.message;switch(D){case"1002":if(!q.getQcprStatus()){return false}var B=H.project;var Y=H.operation;if(B==0&&Y==0){o.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}');z(n.robotName);searchStudentScore(n.robotName);var K=s(n.robotName);q.setScoreInfo(K);q.setQcprStatus(false);e.url("score");return false}break;case"3001":var ae=parseInt(H.undelivered);var F=parseInt(H.depth);var Z=parseInt(H.middle);var E=parseInt(H.left);var ac=parseInt(H.right);var U=parseInt(H.up);var G=parseInt(H.down);var P=parseInt(H.freq);if(P==0){a("#span_breath_num").text(0);a("#span_breath").text(0)}if(Z==0&&E==0&&ac==0&&U==0&&G==0){Z=1}if(Z==1){a("#div_press_position").css("background-color","green")}else{a("#div_press_position").css("background-color","red")}a("#span_press_depth").text(F);c(F);addStudentPressLoopNum(n.robotName,P);var ab=checkPressLoopNum(n.robotName);var Q=checkPressNum(n.robotName);if((ab==1&&Q>30)||(ab==2&&Q>30)||(ab==3&&Q>30)||(ab==4&&Q>30)||(ab==5&&Q>30)){ae=1;F=-1;Z=0;E=0;ac=0;U=0;G=0;P=-1}var R={};R.undelivered=ae;R.depth=F;R.middle=Z;R.left=E;R.right=ac;R.up=U;R.down=G;R.freq=P;var V=orderStep.PRESS;addPressData(n.robotName,R);addStepScore(n.robotName,V,ab,0,R);addStudentStep(n.robotName,V);w(n.robotName,V);a("#div_loop_num").text(ab);a("#span_press_num").text(Q);break;case"3002":var W=parseInt(H.cc);if(W==1){removePressCcScore(n.robotName)}break;case"4000":var A=parseInt(H.tooth);if(A==1){a("#div_tooth").css("background-color","green")}else{a("#div_tooth").css("background-color","red")}changeToothStatus(n.robotName,A);addStudentStep(n.robotName,6);break;case"4001":var M=parseInt(H.airway);if(M==1){a("#div_airway").css("background-color","green")}else{a("#div_airway").css("background-color","red")}changeAirwayStatus(n.robotName,M);addStudentStep(n.robotName,7);w(n.robotName,7);break;case"4003":var ah=parseInt(H.fast);var X=parseInt(H.breath);a("#span_breath").text(X);m(X);addStudentPressLoopNum(n.robotName,-2);var ab=checkPressLoopNum(n.robotName);var N=getToothStatus(n.robotName);var ad=getAirWayStatus(n.robotName);if(N==0||ad==0){ah=-1;X=-1}var L=0;for(var ag in studentStepScoreList){if(studentStepScoreList[ag].robotName==n.robotName){var J=studentStepScoreList[ag].stepScoreList;for(var af in J){if(J[af].step==8&&J[af].loopNum==ab){var O=J[af].stepDataList;L=O.length;break}}break}}if(L==0){if(N==1){var C=qcprStand.TOOTH_SCORE;var V=orderStep.TOOTH;addStepScore(n.robotName,V,0,C,null)}if(ad==1){var V=orderStep.AIRWAY;var C=qcprStand.AIRWAY_SCORE;addStepScore(n.robotName,V,0,C,null)}}var S=checkBreathNum(n.robotName);if((ab==1&&S>2)||(ab==2&&S>2)||(ab==3&&S>2)||(ab==4&&S>2)||(ab==5&&S>2)){ah=-1;X=-1}var I={};I.fast=ah;I.breath=X;var V=orderStep.BREATH;addStepScore(n.robotName,V,ab,C,I);addBreathData(n.robotName,I);addStudentStep(n.robotName,8);w(n.robotName,8);a("#span_breath_num").text(S);if(ab>=5&&S>=2){var T=checkLivingState(n.robotName);if(T==1){o.webSocket.send('{"code":"1001","message":{"pupil":"1","pulse":"1"}}')}else{o.webSocket.send('{"code":"1001","message":{"pupil":"0","pulse":"0"}}')}var aa=new delayTask(function(){o.webSocket.send('{"code":"4004","message":{"finish":"1"}}')});aa.delay(500)}break;case"8003":if(H.power=="1"){t.warning("模拟人断电关机，请检查原因.");if(o.webSocket!=null){o.webSocket.close();o.webSocket=null}q.setQcprStatus(false);q.logout(function(al,ak){e.url("/");return false})}break;case"9001":if(!q.getQcprStatus()){return false}t.warning("你已被强制下机.");q.setKickStatus(true);o.webSocket.send('{"code":"1002","message":{"project":"2","operation":"0"}}');z(n.robotName);searchStudentScore(n.robotName);var K=s(n.robotName);q.setScoreInfo(K);q.setQcprStatus(false);if(o.webSocket!=null){o.webSocket.close();o.webSocket=null}e.url("score");return false;break}});n.showVolume=function(){a("#modalDialogs").modal("show");a(".modal-backdrop").css("opacity",0)};n.volume=3;n.getVolume=function(){n.volume=a("#input_volume").val();var A=parseInt(n.volume)*3;o.webSocket.send('{"code":"4005","message":{"volume":'+A+"}}");if(n.volume>0&&n.volume<=7){a("#span_volume_style").removeClass().addClass("fa fa-volume-down")}else{if(A>9&&A<=15){a("#span_volume_style").removeClass().addClass("fa fa-volume-up")}else{if(A==0){a("#span_volume_style").removeClass().addClass("fa fa-volume-off")}}}a("#input_volume").trigger("click")};var r=qcprStand.BREATH_VOLUME_LOW;var i=qcprStand.BREATH_VOLUME_HEIGHT;function m(A){if(A<r){a("#span_train_breath").css("background-color","#fdc367")}else{if(A>=r&&A<=i){a("#span_train_breath").css("background-color","green")}else{if(A>i){a("#span_train_breath").css("background-color","red")}}}}var d=qcprStand.PRESS_DEEP_LOW;var l=qcprStand.PRESS_DEEP_HEIGHT;function c(A){if(A<d){a("#span_train_press").css("background-color","#fdc367")}else{if(A>=d&&A<=l){a("#span_train_press").css("background-color","green")}else{if(A>l){a("#span_train_press").css("background-color","red")}}}}function w(E,D){for(var C in stepInfoList){if(stepInfoList[C].robotName==E){var B=stepInfoList[C].stepList;for(var A in B){if(B[A]==1){if((parseInt(A)+1)!=D){stepInfoList[C].stepList[A]=2}}}break}}v(E)}function v(E){for(var D in stepInfoList){if(stepInfoList[D].robotName==E){var C=stepInfoList[D].stepList;for(var B in C){var A=C[B];switch(A){case 0:a("#span_view_"+(parseInt(B)+1)).css({"background-color":"#cecece"});break;case 1:a("#span_view_"+(parseInt(B)+1)).css({"background-color":"#f1c40f"});break;case 2:a("#span_view_"+(parseInt(B)+1)).css({"background-color":"#3e66cd"});break;default:break}}break}}}n.finish=function(){try{t.confirm("确认结束QCPR?",function(B){if(B){o.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}');z(n.robotName);searchStudentScore(n.robotName);var C=s(n.robotName);q.setScoreInfo(C);q.setQcprStatus(false);e.url("score")}})}catch(A){t.warning(A.message);return false}};function z(B){for(var A in stepInfoList){if(stepInfoList[A].robotName==B){stepInfoList[A].stepList=[2,2,2,2,2,2,2,2,2];break}}v(B)}function s(D){var C={};for(var A in studentTotalScoreList){if(studentTotalScoreList[A].robotName==D){studentTotalScoreList[A].safeScore=studentTotalScoreList[A].safeScore+studentTotalScoreList[A].safeStepScore;studentTotalScoreList[A].knowScore=studentTotalScoreList[A].knowScore+studentTotalScoreList[A].knowStepScore;studentTotalScoreList[A].pulseScore=studentTotalScoreList[A].pulseScore+studentTotalScoreList[A].pulseStepScore;studentTotalScoreList[A].helpScore=studentTotalScoreList[A].helpScore+studentTotalScoreList[A].helpStepScore;studentTotalScoreList[A].pressScore=studentTotalScoreList[A].pressScore+studentTotalScoreList[A].pressStepScore;studentTotalScoreList[A].toothScore=studentTotalScoreList[A].toothScore+studentTotalScoreList[A].toothStepScore;studentTotalScoreList[A].airwayScore=studentTotalScoreList[A].airwayScore+studentTotalScoreList[A].airwayStepScore;studentTotalScoreList[A].breathScore=studentTotalScoreList[A].breathScore+studentTotalScoreList[A].breathStepScore;studentTotalScoreList[A].assessScore=studentTotalScoreList[A].assessScore+studentTotalScoreList[A].assessStepScore;var B=f(n.examTime);if((parseInt(B)<=qcprStand.EXAM_TIME)&&(loopStepFlag==true)){studentTotalScoreList[A].timeScore=qcprStand.TIME_SCORE}C=studentTotalScoreList[A];break}}return C}function f(A){A=h(A).split(":");return parseInt(A[0])*3600+parseInt(A[1])*60+parseInt(A[2])}function h(A){return A.replace(/^(\s*|　*)/,"")}n.pause=function(){t.pauseConfirm("练习已暂停，点击确定继续.",function(A){if(A){a(".bootbox-close-button").trigger("click");n.pauseStatus=true;a("#btn_start_pause").html("暂停");j=x()}});a("#btn_start_pause").html("继续");p.cancel(j);n.pauseStatus=false;return false};n.reset=function(){try{t.confirm("确定要重置QCPR?",function(B){if(B){o.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}');q.setQcprStatus(false);e.url("cpr_start");return false}})}catch(A){t.warning(A.message);return false}};n.exit=function(){try{t.confirm("确认退出QCPR?",function(B){if(B){o.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}');q.setQcprStatus(false);if(o.webSocket!=null){o.webSocket.close();o.webSocket=null}q.logout(function(D,C){e.url("/");return false})}})}catch(A){t.warning(A.message);return false}};n.$on("$destroy",function(){if(j){p.cancel(j)}})}])});