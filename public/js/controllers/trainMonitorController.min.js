"use strict";define(["jquery","app"],function(a,b){b.controller("trainMonitorController",["$scope","$location","$window","$interval","webSocketService","applicationService","messageBoxService","$timeout",function(o,e,k,q,p,r,u,z){if(p.webSocket==null){e.url("");return false}if(r.getTrainStatus()==false){e.url("score");return false}if(a(".container").parent().height()<r.getMbHeight()){a(".container").parent().css("height","100%")}r.checkBrowers();var n=r.getMbWidth();a(".w-view-210").css({height:30+"px",width:30+"px"});a(".train-img").css({width:"100%",height:"100%","border-width":0});o.time=0;o.examTime="00:00:00";o.dot=false;o.wifiStatus="images/icon_link.png";o.pauseStatus=true;var j=y();function y(){return q(function(){var C=o.time%60;if(C<10){C="0"+C}var D=parseInt(o.time/60);if(D<10){D="0"+D}var B=parseInt(o.time/3600);if(B<10){B="0"+B}o.examTime=B+":"+D+":"+C;o.time=o.time+1},1000)}clearStudentData(o.robotName);createData(o.robotName);var v=getAirWayStatus(o.robotName);if(v==1){a("#div_airway").css("background-color","green")}else{a("#div_airway").css("background-color","red")}var g=getToothStatus(o.robotName);if(g==1){a("#div_tooth").css("background-color","green")}else{a("#div_tooth").css("background-color","red")}k.onunload=function(B){r.exit();return false};o.$on("onOpen",function(B,C){j=y();o.wifiStatus="images/icon_link.png";a(".bootbox-close-button").trigger("click")});o.$on("onError",function(C,D){var B=new delayTask(function(){q.cancel(j)});B.delay(500);o.wifiStatus="images/icon_nolink.png";u.wrong("连接出错,等待重连,请不要关闭窗口.")});o.$on("onClose",function(C,D){if(r.getTrainStatus()){var B=new delayTask(function(){q.cancel(j)});B.delay(500);o.wifiStatus="images/icon_nolink.png";u.wrong("连接关闭,等待重连,请不要关闭窗口.")}});o.$on("onMessage",function(an,am){if(o.pauseStatus==false){return false}var am=JSON.parse(am);var E=am.code;var I=am.message;switch(E){case"2001":var ac=parseInt(I.know);var D=0;var X=orderStep.KNOW;if(ac==1){D=qcprStand.KNOW_SCORE}addStepScore(o.robotName,X,0,D,null);addStudentStep(o.robotName,X);x(o.robotName,X);break;case"2002":var K=parseInt(I.pulse);var D=0;var ae=checkPressLoopNum(o.robotName);if(ae<=3){var X=orderStep.PULSE;addPulseDate(o.robotName,X,K);var ag=getPulseTime(o.robotName,X);if(ag>=qcprStand.PULSE_TIME_LOW&&ag<=qcprStand.PULSE_TIME_HEIGHT){D=qcprStand.PULSE_SCORE}if(K==0){addStepScore(o.robotName,X,0,D,null);addStudentStep(o.robotName,X);x(o.robotName,X)}}else{if(ae>3){var X=orderStep.ASSESS;D=qcprStand.ASSESS_SCORE;if(K==0){addStepScore(o.robotName,X,0,D,null);addStudentStep(o.robotName,X);x(o.robotName,X)}}}break;case"3001":var ai=parseInt(I.undelivered);var G=parseInt(I.depth);var ab=parseInt(I.middle);var F=parseInt(I.left);var af=parseInt(I.right);var W=parseInt(I.up);var H=parseInt(I.down);var R=parseInt(I.freq);if(R==0){a("#span_breath_num").text(0);a("#span_breath").text(0)}if(ab==0&&F==0&&af==0&&W==0&&H==0){ab=1}if(ab==1){a("#div_press_position").css("background-color","green")}else{a("#div_press_position").css("background-color","red")}a("#span_press_depth").text(G);c(G);addStudentPressLoopNum(o.robotName,R);var ae=checkPressLoopNum(o.robotName);var S=checkPressNum(o.robotName);if((ae==1&&S>30)||(ae==2&&S>30)||(ae==3&&S>30)||(ae==4&&S>30)||(ae==5&&S>30)||(ae>5)){ai=1;G=-1;ab=0;F=0;af=0;W=0;H=0;R=-1}var T={};T.undelivered=ai;T.depth=G;T.middle=ab;T.left=F;T.right=af;T.up=W;T.down=H;T.freq=R;var X=orderStep.PRESS;addPressData(o.robotName,T);addStepScore(o.robotName,X,ae,0,T);addStudentStep(o.robotName,X);x(o.robotName,X);a("#div_loop_num").text(ae);a("#span_press_num").text(S);break;case"3002":var Y=parseInt(I.cc);if(Y==1){removePressCcScore(o.robotName)}break;case"4000":var C=parseInt(I.tooth);changeToothStatus(o.robotName,C);addStudentStep(o.robotName,6);if(C==1){a("#div_tooth").css("background-color","green")}else{a("#div_tooth").css("background-color","red")}break;case"4001":var O=parseInt(I.airway);changeAirwayStatus(o.robotName,O);addStudentStep(o.robotName,7);x(o.robotName,7);if(O==1){a("#div_airway").css("background-color","green")}else{a("#div_airway").css("background-color","red")}break;case"4003":var al=parseInt(I.fast);var Z=parseInt(I.breath);a("#span_breath").text(Z);var P=getToothStatus(o.robotName);var ah=getAirWayStatus(o.robotName);m(Z);addStudentPressLoopNum(o.robotName,-2);var ae=checkPressLoopNum(o.robotName);if(P==0||ah==0){al=-1;Z=-1}var N=0;for(var ak in studentStepScoreList){if(studentStepScoreList[ak].robotName==o.robotName){var L=studentStepScoreList[ak].stepScoreList;for(var aj in L){if(L[aj].step==8&&L[aj].loopNum==ae){var Q=L[aj].stepDataList;N=Q.length;break}}break}}if(N==0){if(P==1){var D=qcprStand.TOOTH_SCORE;var X=orderStep.TOOTH;addStepScore(o.robotName,X,0,D,null)}if(ah==1){var X=orderStep.AIRWAY;var D=qcprStand.AIRWAY_SCORE;addStepScore(o.robotName,X,0,D,null)}}var U=checkBreathNum(o.robotName);if((ae==1&&U>2)||(ae==2&&U>2)||(ae==3&&U>2)||(ae==4&&U>2)||(ae==5&&U>2)||(ae>5)){al=-1;Z=-1}var J={};J.fast=al;J.breath=Z;var X=orderStep.BREATH;addStepScore(o.robotName,X,ae,D,J);addBreathData(o.robotName,J);addStudentStep(o.robotName,8);x(o.robotName,8);a("#span_breath_num").text(U);if(ae>=5&&U>=2){var V=checkLivingState(o.robotName);if(V==1){p.webSocket.send('{"code":"1001","message":{"pupil":"1","pulse":"1"}}')}else{p.webSocket.send('{"code":"1001","message":{"pupil":"0","pulse":"0"}}')}var ad=new delayTask(function(){p.webSocket.send('{"code":"4004","message":{"finish":"1"}}')});ad.delay(500)}break;case"1002":if(!r.getTrainStatus()){return false}var B=parseInt(I.project);var aa=parseInt(I.operation);if(B==0&&aa==0){if(p.webSocket!=null){p.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}')}r.setTrainStatus(false);A(o.robotName);searchStudentScore(o.robotName);var M=t(o.robotName);r.setScoreInfo(M);e.url("score")}break;case"8003":if(I.power=="1"){u.warning("模拟人断电关机，请检查原因.");r.setTrainStatus(false);if(p.webSocket!=null){p.webSocket.close();p.webSocket=null}r.logout(function(ap,ao){e.url("/");return false})}break;case"9001":if(!r.getTrainStatus()){return false}u.warning("你已被强制下机.");r.setKickStatus(true);if(p.webSocket!=null){p.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}')}r.setTrainStatus(false);A(o.robotName);searchStudentScore(o.robotName);var M=t(o.robotName);r.setScoreInfo(M);if(p.webSocket!=null){p.webSocket.close();p.webSocket=null}e.url("score");break}});o.confirmSafe=function(){if(o.pauseStatus==false){return false}a("#safeConfirm").css("background-color","#f2f2f2");z(function(){a("#safeConfirm").css("background-color","#fff");a("#safeMessage").text("已确认");a("#safeMessage").css("color","#1EBBFC")},150);if(p.webSocket!=null){p.webSocket.send('{"code":"2000","message":{"safe":"1"}}')}var C=qcprStand.SAFE_SCORE;var B=orderStep.SAFE;addStepScore(o.robotName,B,0,C,null);addStudentStep(o.robotName,B);x(o.robotName,B);return false};o.confirmHelp=function(){if(o.pauseStatus==false){return false}a("#helpConfirm").css("background-color","#f2f2f2");z(function(){a("#helpConfirm").css("background-color","#fff")},150);a("#modalDialog").modal("show");o.phoneNum="";return false};o.phoneNum="";o.dialPhone=function(B){a("#num"+B).css("background-color","#fff");switch(B){case 10:var D=0;var C=orderStep.HELP;if(o.phoneNum=="120"&&p.webSocket!=null){p.webSocket.send('{"code":"2003","message":{"help":"1"}}');D=qcprStand.HELP_SCORE;addStepScore(o.robotName,C,0,D,null);addStudentStep(o.robotName,C);x(o.robotName,C)}else{if(o.phoneNum!="120"&&p.webSocket!=null){p.webSocket.send('{"code":"2003","message":{"help":"1"}}');D=0;addStepScore(o.robotName,C,0,D,null);addStudentStep(o.robotName,C);x(o.robotName,C)}}a("#modalDialog").modal("hide");a("#helpMessage").text("已拨打");a("#helpMessage").css("color","#3ECBCD");break;case 11:o.phoneNum=o.phoneNum.substring(0,o.phoneNum.length-1);break;default:if(o.phoneNum.length<=11){o.phoneNum=o.phoneNum+""+B}break}return false};o.dialPhoneBg=function(B){a("#num"+B).css("background-color","#f2f2f2");return false};o.trainReset=function(){try{u.confirm("确认重置练习?",function(C){if(C){if(p.webSocket!=null){p.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}');r.setTrainStatus(false);e.url("train_start")}}})}catch(B){u.warning(B.message);return false}};o.trainPause=function(){u.pauseConfirm("练习已暂停，点击确定继续.",function(B){if(B){a(".bootbox-close-button").trigger("click");j=y();a("#btn_start_pause").html("暂停");o.pauseStatus=true}});q.cancel(j);a("#btn_start_pause").html("继续");o.pauseStatus=false;return false};o.trainFinish=function(){try{u.confirm("确认结束练习?",function(C){if(C){if(p.webSocket!=null){p.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}')}r.setTrainStatus(false);A(o.robotName);searchStudentScore(o.robotName);var D=t(o.robotName);r.setScoreInfo(D);e.url("score")}})}catch(B){u.warning(B.message);return false}};o.exit=function(){try{u.confirm("确认退出练习?",function(C){if(C){if(p.webSocket!=null){p.webSocket.send('{"code":"1002","message":{"project":"0","operation":"0"}}')}r.setTrainStatus(false);if(p.webSocket){p.webSocket.close();p.webSocket=null}r.logout(function(E,D){e.url("/");return false})}})}catch(B){u.warning(B.message);return false}};o.showVolume=function(){a("#modalDialogs").modal("show");a(".modal-backdrop").css("opacity",0)};o.volume=3;o.getVolume=function(){o.volume=a("#input_volume").val();var B=parseInt(o.volume)*3;p.webSocket.send('{"code":"4005","message":{"volume":'+B+"}}");if(o.volume>0&&o.volume<=7){a("#span_volume_style").removeClass().addClass("fa fa-volume-down")}else{if(B>9&&B<=15){a("#span_volume_style").removeClass().addClass("fa fa-volume-up")}else{if(B==0){a("#span_volume_style").removeClass().addClass("fa fa-volume-off")}}}a("#input_volume").trigger("click")};var d=qcprStand.PRESS_DEEP_LOW;var l=qcprStand.PRESS_DEEP_HEIGHT;function c(B){if(B<d){a("#span_train_press").css("background-color","#fdc367")}else{if(B>=d&&B<=l){a("#span_train_press").css("background-color","green")}else{if(B>l){a("#span_train_press").css("background-color","red")}}}}var s=qcprStand.BREATH_VOLUME_LOW;var i=qcprStand.BREATH_VOLUME_HEIGHT;function m(B){if(B<s){a("#span_train_breath").css("background-color","#fdc367")}else{if(B>=s&&B<=i){a("#span_train_breath").css("background-color","green")}else{if(B>i){a("#span_train_breath").css("background-color","red")}}}}function x(F,E){for(var D in stepInfoList){if(stepInfoList[D].robotName==F){var C=stepInfoList[D].stepList;for(var B in C){if(C[B]==1){if((parseInt(B)+1)!=E){stepInfoList[D].stepList[B]=2}}}break}}w(F)}function w(F){for(var E in stepInfoList){if(stepInfoList[E].robotName==F){var D=stepInfoList[E].stepList;for(var C in D){var B=D[C];switch(B){case 0:a("#span_view_"+(parseInt(C)+1)).css({"background-color":"#969596"});break;case 1:a("#span_view_"+(parseInt(C)+1)).css({"background-color":"#f1c40f"});break;case 2:a("#span_view_"+(parseInt(C)+1)).css({"background-color":"#3e66cd"});break;default:break}}break}}}function A(C){for(var B in stepInfoList){if(stepInfoList[B].robotName==C){stepInfoList[B].stepList=[2,2,2,2,2,2,2,2,2];break}}w(C)}function t(E){var C={};for(var B in studentTotalScoreList){if(studentTotalScoreList[B].robotName==E){studentTotalScoreList[B].safeScore=studentTotalScoreList[B].safeScore+studentTotalScoreList[B].safeStepScore;studentTotalScoreList[B].knowScore=studentTotalScoreList[B].knowScore+studentTotalScoreList[B].knowStepScore;studentTotalScoreList[B].pulseScore=studentTotalScoreList[B].pulseScore+studentTotalScoreList[B].pulseStepScore;studentTotalScoreList[B].helpScore=studentTotalScoreList[B].helpScore+studentTotalScoreList[B].helpStepScore;studentTotalScoreList[B].pressScore=studentTotalScoreList[B].pressScore+studentTotalScoreList[B].pressStepScore;studentTotalScoreList[B].toothScore=studentTotalScoreList[B].toothScore+studentTotalScoreList[B].toothStepScore;studentTotalScoreList[B].airwayScore=studentTotalScoreList[B].airwayScore+studentTotalScoreList[B].airwayStepScore;studentTotalScoreList[B].breathScore=studentTotalScoreList[B].breathScore+studentTotalScoreList[B].breathStepScore;studentTotalScoreList[B].assessScore=studentTotalScoreList[B].assessScore+studentTotalScoreList[B].assessStepScore;var D=f(o.examTime);if((parseInt(D)<=qcprStand.EXAM_TIME)&&(loopStepFlag==true)){studentTotalScoreList[B].timeScore=qcprStand.TIME_SCORE}C=studentTotalScoreList[B];break}}return C}function f(B){B=h(B).split(":");return parseInt(B[0])*3600+parseInt(B[1])*60+parseInt(B[2])}function h(B){return B.replace(/^(\s*|　*)/,"")}o.$on("$destroy",function(){if(j){q.cancel(j)}})}])});