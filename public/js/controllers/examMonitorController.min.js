"use strict";define(["jquery","app"],function(a,b){b.controller("examMonitorController",["$window","$scope","webSocketService","applicationService","$location","messageBoxService","$interval","$timeout","$http",function(d,m,f,e,h,k,i,g,l){if(e.getUser()==null){h.url("");return false}if(e.getExamStatus()==false){h.url("score");return false}if(a(".container").parent().height()<e.getMbHeight()){a(".container").parent().css("height","100%")}e.checkBrowers();a(".container").css("top",a(".header").height()+"px");m.user=e.getUser();m.ip=m.user.robotIp;m.userCnName=m.user.userCnName;m.userAccount=m.user.userAccount;m.robotName=m.user.robotName;m.time=0;m.examTime="00:00:00";m.dot=false;m.wifiStatus="images/icon_link.png";var c=i(function(){f.webSocket.send('{"code":"8002","message":{"usertype":"3","times":"0"}}')},1000);function j(){var o=m.time%60;if(o<10){o="0"+o}var p=parseInt(m.time/60);if(p<10){p="0"+p}var n=parseInt(m.time/3600);if(n<10){n="0"+n}m.examTime=n+":"+p+":"+o;m.time=m.time+1}d.onunload=function(n){try{if(f.webSocket!=null){f.webSocket.send('{"code":"1002","message":{"project":"1","operation":"0"}}')}e.exit()}catch(n){k.warning(n.message);return false}};m.$on("onOpen",function(n,o){f.webSocket.send('{"code":"8002","message":{"usertype":"3","times":"0"}}');m.wifiStatus="images/icon_link.png";a(".bootbox-close-button").trigger("click");j()});m.$on("onError",function(n,o){m.wifiStatus="images/icon_nolink.png";k.wrong("连接出错,等待重连,请不要关闭窗口.")});m.$on("onClose",function(n,o){if(e.getExamStatus()){m.wifiStatus="images/icon_nolink.png";k.wrong("连接关闭,等待重连,请不要关闭窗口.")}});m.$on("onMessage",function(p,q){var q=JSON.parse(q);var o=q.code;var n=q.message;switch(o){case"4001":var t=parseInt(n.airway);m.dot=(t==0)?false:true;break;case"8000":e.setExamStatus(false);if(parseInt(n.finish)==1){a(".data-loading").show();try{var s={};s.userId=e.getUser().userId;e.getScore(s,function(v,u){a(".data-loading").hide();if(v!=0){k.warning(u);return false}e.setScoreInfo(u);h.url("score");return false})}catch(r){a(".data-loading").hide();k.warning(r.message);return false}}break;case"8002":if(n.usertype=="2"){m.time=parseInt(n.times)+1;j()}break;case"8003":if(n.power=="1"){k.warning("模拟人断电关机，请检查原因.");if(f.webSocket!=null){f.webSocket.close();f.webSocket=null}e.setExamStatus(false);e.logout(function(v,u){h.url("/");return false})}break;case"9001":k.warning("你已被强制下机.");if(f.webSocket!=null){f.webSocket.close();f.webSocket=null}break}});m.finish=function(){try{k.confirm("确认结束考试?",function(o){if(o){if(f.webSocket!=null){f.webSocket.send('{"code":"1002","message":{"project":"1","operation":"0"}}')}}})}catch(n){k.warning(n.message);return false}};m.exit=function(){try{k.confirm("确认退出考试?",function(o){if(o){if(f.webSocket!=null){f.webSocket.send('{"code":"1002","message":{"project":"1","operation":"0"}}')}e.setExamStatus(false);if(f.webSocket!=null){f.webSocket.close();f.webSocket=null}e.logout(function(q,p){h.url("/");return false})}})}catch(n){k.warning(n.message);return false}};m.confirmSafe=function(){try{a("#safeConfirm").css("background-color","#f2f2f2");g(function(){a("#safeConfirm").css("background-color","#fff");a("#safeMessage").text("已确认");a("#safeMessage").css("color","#1EBBFC")},150);if(f.webSocket!=null){f.webSocket.send('{"code":"2000","message":{"safe":"1"}}')}}catch(n){k.warning(n.message);return false}};m.confirmHelp=function(n){a("#helpConfirm").css("background-color","#f2f2f2");g(function(){a("#helpConfirm").css("background-color","#fff")},150);a("#modalDialog").modal("show");m.phoneNum="";return false};m.phoneNum="";m.dialPhone=function(n){a("#num"+n).css("background-color","#fff");switch(n){case 10:if(m.phoneNum=="120"&&f.webSocket!=null){f.webSocket.send('{"code":"2003","message":{"help":"1"}}')}else{if(m.phoneNum!="120"&&f.webSocket!=null){f.webSocket.send('{"code":"2003","message":{"help":"0"}}')}}a("#modalDialog").modal("hide");a("#helpMessage").text("已拨打");a("#helpMessage").css("color","#3ECBCD");break;case 11:m.phoneNum=m.phoneNum.substring(0,m.phoneNum.length-1);break;default:if(m.phoneNum.length<=11){m.phoneNum=m.phoneNum+""+n}break}return false};m.dialPhoneBg=function(n){a("#num"+n).css("background-color","#f2f2f2");return false};m.$on("$destroy",function(){if(c){i.cancel(c)}})}])});